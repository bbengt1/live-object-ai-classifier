# Story P16-2.3: Create LiveStreamPlayer Frontend Component

Status: done

## Story

As a **user**,
I want **a video player component for live streams**,
So that **I can watch camera feeds in the browser**.

## Acceptance Criteria

1. **Given** the LiveStreamPlayer component with cameraId prop
   **When** mounted
   **Then** it connects to the WebSocket stream endpoint and displays video

2. **Given** stream quality options are available
   **When** I click the quality selector
   **Then** I can choose between Low, Medium, High quality
   **And** the stream reconnects at the new quality

3. **Given** the player is showing video
   **When** I click the fullscreen button
   **Then** the video expands to fullscreen mode
   **And** pressing Escape exits fullscreen

4. **Given** the stream fails to connect
   **When** after 5 seconds
   **Then** a fallback message shows "Stream unavailable"
   **And** a "Retry" button is available
   **And** snapshot fallback shows latest frame with 2-second refresh

5. **And** player shows loading spinner while connecting
   **And** player has mute/unmute toggle (muted by default)
   **And** player displays camera name overlay

## Tasks / Subtasks

- [x] Task 1: Create LiveStreamPlayer component (AC: 1, 5)
  - [x] Create `frontend/components/streaming/LiveStreamPlayer.tsx`
  - [x] Implement WebSocket connection to `/api/v1/cameras/{id}/stream`
  - [x] Render binary JPEG frames to img element with blob URLs
  - [x] Show loading spinner during initial connection
  - [x] Display camera name overlay

- [x] Task 2: Create StreamQualitySelector component (AC: 2)
  - [x] Create `frontend/components/streaming/StreamQualitySelector.tsx`
  - [x] Use shadcn/ui Popover for dropdown
  - [x] Fetch quality options from `/api/v1/cameras/{id}/stream/info`
  - [x] Send quality change message via WebSocket
  - [x] Show current quality indicator with icon

- [x] Task 3: Implement fullscreen support (AC: 3)
  - [x] Add fullscreen button using lucide-react Maximize2 icon
  - [x] Use Fullscreen API for cross-browser support
  - [x] Handle Escape key to exit fullscreen
  - [x] Adjust overlay positions in fullscreen mode

- [x] Task 4: Implement error handling and fallback (AC: 4)
  - [x] Set 5-second connection timeout
  - [x] Show "Stream unavailable" message on failure
  - [x] Add "Retry" button to reconnect
  - [x] Implement snapshot fallback mode with 2-second refresh
  - [x] Use `/api/v1/cameras/{id}/stream/snapshot` for fallback

- [x] Task 5: Add audio controls (AC: 5)
  - [x] Add mute/unmute toggle button
  - [x] Default to muted state
  - [x] Use lucide-react Volume2/VolumeX icons

- [x] Task 6: Add API client methods
  - [x] Add `getStreamInfo(cameraId)` to api-client.ts
  - [x] Add `getStreamSnapshot(cameraId, quality)` to api-client.ts
  - [x] Add `getStreamWebSocketUrl(cameraId, quality)` to api-client.ts
  - [x] Add `getStreamMetrics()` to api-client.ts
  - [x] Add TypeScript types for stream responses to camera.ts

- [x] Task 7: Write tests
  - [x] Unit tests for LiveStreamPlayer component (17 tests)
  - [x] Unit tests for StreamQualitySelector (18 tests)
  - [x] Mock WebSocket for testing

## Dev Notes

### Technical Context

- **Epic**: P16-2 - Live Camera Streaming
- **GitHub Issue**: #356
- **FRs Covered**: FR16, FR17, FR18, FR19, FR20
- **Prerequisites**: P16-2.2 (Backend Stream Proxy Service) ✅

### Implementation Approach (from P16-2.1 Design)

**Frontend receives MJPEG via WebSocket**:
- Backend sends binary JPEG frames
- Frontend renders to `<img>` with blob URL or `<canvas>`
- JSON control messages for quality change and ping/pong

### WebSocket Protocol

**Server → Client (binary)**: JPEG frame data
**Server → Client (JSON)**:
- `{"type": "quality_changed", "quality": "high"}`
- `{"type": "pong"}`
- `{"type": "error", "message": "..."}`
- `{"type": "info", "message": "...", "quality": "medium"}`

**Client → Server (JSON)**:
- `{"type": "quality_change", "quality": "high"}`
- `{"type": "ping"}`

### Quality Levels

| Quality | Resolution | FPS | Use Case |
|---------|------------|-----|----------|
| Low | 640x360 | 5 | Mobile, poor connection |
| Medium | 1280x720 | 10 | Default viewing |
| High | 1920x1080 | 15 | Detailed analysis |

### Fallback Strategy

```
┌─────────────────────────────────────────────────────────────┐
│                    Mount Component                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Connect WebSocket│
                    │   (5s timeout)   │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │ Success                       │ Timeout/Error
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  Live Stream    │             │  Snapshot Mode  │
    │  (MJPEG frames) │             │  (2s refresh)   │
    └─────────────────┘             └─────────────────┘
```

### Project Structure Notes

- New component: `frontend/components/streaming/LiveStreamPlayer.tsx`
- New component: `frontend/components/streaming/StreamQualitySelector.tsx`
- Modify: `frontend/lib/api-client.ts` (add streaming methods)
- New types: `frontend/types/streaming.ts` (or inline)

### Learnings from Previous Story

**From Story P16-2.2 (Status: done)**

- **Backend Service Created**: `StreamProxyService` at `backend/app/services/stream_proxy_service.py`
- **API Endpoints Available**:
  - `GET /api/v1/cameras/{id}/stream/info` - Returns quality options, client count
  - `GET /api/v1/cameras/{id}/stream/snapshot` - Returns JPEG snapshot
  - `WS /api/v1/cameras/{id}/stream` - WebSocket for live frames
  - `GET /api/v1/cameras/stream/metrics` - Server-wide metrics
- **WebSocket Message Format**: Binary JPEG frames + JSON control messages
- **Quality Levels**: low, medium, high (matching design doc)
- **Schemas Available**: `StreamInfoResponse`, `StreamSnapshotResponse` in `backend/app/schemas/camera.py`

[Source: docs/sprint-artifacts/P16-2.2.md#Dev-Agent-Record]

### References

- [Source: docs/sprint-artifacts/p16-2-1-streaming-design.md#Section-5.2]
- [Source: docs/sprint-artifacts/P16-2.2.md - Backend implementation]
- [Source: docs/epics-phase16.md#Story-P16-2.3]
- [Source: backend/app/schemas/camera.py - Stream response schemas]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

1. Created `LiveStreamPlayer` component with full WebSocket streaming support
2. Implemented MJPEG frame rendering using blob URLs for efficient memory management
3. Added `StreamQualitySelector` with shadcn/ui Popover for quality selection (Low/Medium/High)
4. Fullscreen support using native Fullscreen API with Escape key handling
5. Snapshot fallback mode with 2-second refresh on WebSocket connection failure
6. Mute/unmute toggle defaulting to muted state
7. Added streaming types to `frontend/types/camera.ts` matching backend schemas
8. Added API client methods: `getStreamInfo`, `getStreamSnapshot`, `getStreamWebSocketUrl`, `getStreamMetrics`
9. 35 unit tests passing (17 for LiveStreamPlayer, 18 for StreamQualitySelector)
10. Components wrapped with React.memo for performance optimization

### File List

- `frontend/components/streaming/LiveStreamPlayer.tsx` (NEW) - Main live stream player component
- `frontend/components/streaming/StreamQualitySelector.tsx` (NEW) - Quality selector dropdown
- `frontend/components/streaming/index.ts` (NEW) - Component exports
- `frontend/types/camera.ts` (MODIFIED) - Added streaming types
- `frontend/lib/api-client.ts` (MODIFIED) - Added streaming API methods
- `frontend/__tests__/components/streaming/LiveStreamPlayer.test.tsx` (NEW) - Unit tests
- `frontend/__tests__/components/streaming/StreamQualitySelector.test.tsx` (NEW) - Unit tests

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-01 | Story created | Claude Code |
