# Story P11-4.1: Add Text Encoding to EmbeddingService

Status: done

## Story

As a system,
I want to encode text queries into embeddings,
So that I can compare queries against frame content for query-adaptive frame selection.

## Acceptance Criteria

1. AC-4.1.1: EmbeddingService.encode_text(query) method added
2. AC-4.1.2: Uses same CLIP model as image encoding
3. AC-4.1.3: Text embeddings compatible with image embeddings (same 512-dim space)
4. AC-4.1.4: Query preprocessing (lowercase, trim)
5. AC-4.1.5: "a photo of {query}" formatting for short queries (<=3 words)

## Tasks / Subtasks

- [x] Task 1: Add encode_text() method to EmbeddingService (AC: 4.1.1, 4.1.2)
  - [x] 1.1: Implement encode_text() method using CLIP text encoder
  - [x] 1.2: Ensure model is loaded before encoding (reuse _ensure_model_loaded)
  - [x] 1.3: Return 512-dim embedding as list[float]

- [x] Task 2: Implement query preprocessing (AC: 4.1.4)
  - [x] 2.1: Strip whitespace from query
  - [x] 2.2: Convert to lowercase
  - [x] 2.3: Validate query is not empty

- [x] Task 3: Add query formatting for CLIP (AC: 4.1.5)
  - [x] 3.1: Count words in query
  - [x] 3.2: Format short queries (<=3 words) with "a photo of {query}" prefix
  - [x] 3.3: Pass through longer queries unchanged

- [x] Task 4: Add structured logging (AC: all)
  - [x] 4.1: Log text encoding start with query_length
  - [x] 4.2: Log encoding completion with duration_ms

- [x] Task 5: Write unit tests (AC: all)
  - [x] 5.1: Test encode_text returns 512-dim vector
  - [x] 5.2: Test query preprocessing (strip, lowercase)
  - [x] 5.3: Test short query formatting ("a photo of")
  - [x] 5.4: Test long query pass-through
  - [x] 5.5: Test empty query raises ValueError
  - [x] 5.6: Test embedding compatibility (same dimension as image)

## Dev Notes

### Architecture Patterns

This story extends the existing EmbeddingService to support text encoding using the same CLIP model already used for image encoding. The sentence-transformers library provides a unified `encode()` method that works with both images and text.

**Key Design Decisions:**
- Reuse existing CLIP ViT-B/32 model (no new dependencies)
- Use sentence-transformers encode() for text (same as images)
- Query formatting follows CLIP best practices for better matching

### Implementation Details

**CLIP Text Encoding:**
The sentence-transformers CLIP model can encode text directly:
```python
embedding = self._model.encode("a photo of a package")
```

**Query Formatting:**
CLIP was trained with "a photo of {object}" format, so short queries benefit from this prefix. Longer sentences can be passed through unchanged.

### Project Structure Notes

- Modify: `backend/app/services/embedding_service.py` - Add encode_text() method
- Modify: `backend/tests/test_services/test_embedding_service.py` - Add text encoding tests

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-4.md#TextEncoding]
- [Source: docs/research/query-adaptive-frames-research.md#3.2-Text-Query-Encoding]
- [Source: backend/app/services/embedding_service.py] - Existing implementation

### Learnings from Previous Story

**From Story P11-3.4 (Status: done)**

- **Prometheus Metrics Pattern**: Use MCP_* prefix for metrics, define at module level
- **Performance Logging**: Log warning when operations exceed threshold (e.g., 50ms)
- **Test Patterns**: Use mock_model fixture with numpy array returns for CLIP tests
- **Counter Import**: Be careful with Counter import (prometheus vs collections)

[Source: docs/sprint-artifacts/P11-3-4.md#Dev-Agent-Record]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-3-4.md (prior story learnings)
- docs/research/query-adaptive-frames-research.md (query-adaptive research)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- Added encode_text() method to EmbeddingService
- Implemented query preprocessing (strip, lowercase)
- Added _format_query_for_clip() helper for query formatting
- Short queries (<=3 words) get "a photo of" prefix
- Longer queries pass through unchanged
- Added structured logging for text encoding events
- All 34 tests pass (16 new tests for text encoding)

### File List

**Modified:**
- backend/app/services/embedding_service.py - Added encode_text() and _format_query_for_clip()
- backend/tests/test_services/test_embedding_service.py - Added TestTextEncoding and TestQueryFormatting classes

**Added:**
- docs/sprint-artifacts/P11-4-1.md - Story file

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tests passing |
