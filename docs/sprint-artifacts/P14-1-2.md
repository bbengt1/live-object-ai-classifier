# Story P14-1.2: Remove or Secure Debug Endpoints

Status: done

## Story

As a **security-conscious administrator**,
I want debug endpoints to be disabled by default,
so that sensitive internal information is not exposed to unauthorized network users.

## Acceptance Criteria

1. **AC1**: `GET /api/v1/system/debug/ai-keys` returns 404 when `DEBUG_ENDPOINTS_ENABLED=false` (default)
2. **AC2**: `GET /api/v1/system/debug/network` returns 404 when `DEBUG_ENDPOINTS_ENABLED=false` (default)
3. **AC3**: Debug endpoints are not visible in OpenAPI/Swagger documentation when disabled
4. **AC4**: `DEBUG_ENDPOINTS_ENABLED` defaults to `false`
5. **AC5**: `.env.example` documents the new variable with security warning
6. **AC6**: When `DEBUG_ENDPOINTS_ENABLED=true`, endpoints work as before (for development)

## Tasks / Subtasks

- [x] Task 1: Add `DEBUG_ENDPOINTS_ENABLED` setting to config.py (AC: 4)
  - [x] Add boolean field with default=False
  - [x] Add descriptive comment about security implications
- [x] Task 2: Conditionally register debug endpoints (AC: 1, 2, 3, 6)
  - [x] Move endpoint definitions inside conditional block
  - [x] Use `include_in_schema=False` to hide from OpenAPI when enabled
  - [x] Ensure endpoints return 404 (not registered at all) when disabled
- [x] Task 3: Update `.env.example` (AC: 5)
  - [x] Add DEBUG_ENDPOINTS_ENABLED=false with security warning
- [x] Task 4: Add unit tests for debug endpoint security (AC: 1, 2, 3)
  - [x] Test endpoints return 404 when disabled
  - [x] Test endpoints not in OpenAPI schema when disabled
  - [x] (Test for enabled mode requires separate test with env var override - not practical for CI)

## Dev Notes

### Technical Context

The debug endpoints at `backend/app/api/v1/system.py:53-119` expose sensitive information:
- `/debug/ai-keys` - Shows API key storage structure, encrypted prefixes, lengths
- `/debug/network` - Exposes internal IP addresses (10.0.1.254), RTSP URLs, credentials

**Current Security Issues:**
1. Endpoints are always available (no authentication)
2. Visible in OpenAPI documentation
3. Expose internal network topology

**Solution: Conditional Registration**
Rather than adding authentication (which would return 401/403 and confirm endpoint existence), we simply don't register the endpoints when disabled. This returns a clean 404 that doesn't leak any information.

### Project Structure Notes

- Config: `backend/app/core/config.py` - Add DEBUG_ENDPOINTS_ENABLED setting
- API: `backend/app/api/v1/system.py` - Wrap endpoints in conditional
- Env: `backend/.env.example` - Document new variable
- Tests: `backend/tests/test_api/test_system.py` - Add security tests

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P14-1.md#Story-P14-1.2]
- [Source: docs/epics-phase14.md#Story-P14-1.2]
- [Source: docs/backlog.md#TD-023]

## Dev Agent Record

### Context Reference

<!-- N/A - YOLO workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- All 3 security tests pass

### Completion Notes List

- Added `DEBUG_ENDPOINTS_ENABLED` setting to config.py with default=False
- Wrapped debug endpoints in conditional block - endpoints are not registered when disabled
- Added `include_in_schema=False` to hide from OpenAPI even when enabled
- Added security warning log when endpoints are enabled
- Updated .env.example with security warning documentation
- Added 3 new unit tests for endpoint security

### File List

- MODIFIED: `backend/app/core/config.py` - Added DEBUG_ENDPOINTS_ENABLED setting
- MODIFIED: `backend/app/api/v1/system.py` - Conditional endpoint registration
- MODIFIED: `backend/.env.example` - Documented new setting
- MODIFIED: `backend/tests/test_api/test_system.py` - Added security tests

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-29 | Story drafted from Epic P14-1 | SM Agent |
