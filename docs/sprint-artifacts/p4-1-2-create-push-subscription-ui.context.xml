<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>P4-1</epicId>
    <storyId>2</storyId>
    <title>Create Push Subscription UI</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p4-1-2-create-push-subscription-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to enable push notifications through an intuitive UI that requests permission and manages my subscription</iWant>
    <soThat>I can receive real-time alerts about security events on my devices without keeping the app open</soThat>
    <tasks>
      <task id="1" ac="1,4">
        <title>Create PushNotificationSettings component</title>
        <subtasks>
          <item>Create frontend/components/settings/PushNotificationSettings.tsx</item>
          <item>Add enable/disable toggle with react-hook-form</item>
          <item>Display current subscription status (enabled/disabled/permission-denied)</item>
          <item>Show device/browser info when subscribed</item>
          <item>Add section to Settings page</item>
        </subtasks>
      </task>
      <task id="2" ac="2,3">
        <title>Implement notification permission request flow</title>
        <subtasks>
          <item>Create frontend/hooks/usePushNotifications.ts hook</item>
          <item>Implement requestPermission() using Notification API</item>
          <item>Handle granted/denied/default permission states</item>
          <item>Create PermissionDeniedBanner component</item>
          <item>Add browser-specific guidance</item>
        </subtasks>
      </task>
      <task id="3" ac="4,6">
        <title>Implement push subscription management</title>
        <subtasks>
          <item>Fetch VAPID public key from GET /api/v1/push/vapid-public-key</item>
          <item>Use PushManager.subscribe() with applicationServerKey</item>
          <item>Send subscription to POST /api/v1/push/subscribe</item>
          <item>Implement unsubscribe calling DELETE /api/v1/push/subscribe</item>
          <item>Handle subscription errors gracefully</item>
        </subtasks>
      </task>
      <task id="4" ac="5">
        <title>Add test notification feature</title>
        <subtasks>
          <item>Add Send Test Notification button to settings</item>
          <item>Create backend endpoint POST /api/v1/push/test (or use existing service)</item>
          <item>Show success/failure toast after test</item>
          <item>Include loading state during test send</item>
        </subtasks>
      </task>
      <task id="5" ac="7">
        <title>Create notification preview component</title>
        <subtasks>
          <item>Create NotificationPreview component</item>
          <item>Display mock notification with sample data</item>
          <item>Show expected icon, title, body format</item>
        </subtasks>
      </task>
      <task id="6" ac="1,4,5,6">
        <title>Add API client methods</title>
        <subtasks>
          <item>Add getVapidPublicKey() to API client</item>
          <item>Add subscribeToPush(subscription) to API client</item>
          <item>Add unsubscribeFromPush(endpoint) to API client</item>
          <item>Add sendTestNotification() to API client</item>
          <item>Add TypeScript types for push API responses</item>
        </subtasks>
      </task>
      <task id="7" ac="3,8">
        <title>Handle edge cases and error states</title>
        <subtasks>
          <item>Handle browser not supporting Push API</item>
          <item>Handle service worker not registered</item>
          <item>Show loading spinner during async operations</item>
          <item>Display user-friendly error messages</item>
          <item>Add retry button for failed operations</item>
        </subtasks>
      </task>
      <task id="8" ac="all">
        <title>Write tests</title>
        <subtasks>
          <item>Unit tests for usePushNotifications hook (mock Notification API)</item>
          <item>Component tests for PushNotificationSettings</item>
          <item>API client tests for push endpoints</item>
          <item>E2E test for enable/disable flow</item>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Settings page displays "Push Notifications" section with clear enable/disable toggle</criterion>
    <criterion id="2">Clicking enable triggers browser notification permission request</criterion>
    <criterion id="3">Permission denied state shows clear message and guidance for re-enabling</criterion>
    <criterion id="4">Successful subscription shows "Notifications enabled" confirmation with device info</criterion>
    <criterion id="5">User can send a test notification from settings to verify setup</criterion>
    <criterion id="6">Disable toggle unsubscribes and removes subscription from backend</criterion>
    <criterion id="7">UI shows notification preview/example of what alerts will look like</criterion>
    <criterion id="8">Loading and error states handled gracefully during subscription process</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD-phase4.md</path>
        <title>Phase 4 PRD</title>
        <section>Push Notifications</section>
        <snippet>FR10-FR14: Web Push API integration, thumbnails in notifications, per-camera preferences, quiet hours, PWA install. NFR2: Push notifications delivered within 5 seconds.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase4.md</path>
        <title>Phase 4 Epics</title>
        <section>Epic P4-1: Push Notifications and PWA</section>
        <snippet>Story P4-1.2: Add notification permission request flow, build subscription management in settings, show notification preview, handle permission denied gracefully.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Frontend Stack</section>
        <snippet>Next.js 15 App Router, React 19, TanStack Query, Tailwind CSS 4, shadcn/ui components. Hooks pattern for state management.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/p4-1-1-implement-web-push-backend.md</path>
        <title>Story P4-1.1: Implement Web Push Backend</title>
        <section>Completion Notes</section>
        <snippet>Backend complete with 4 API endpoints: GET /push/vapid-public-key, POST/DELETE /push/subscribe, GET /push/subscriptions. VAPID public key is URL-safe base64 encoded.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>frontend/app/settings/page.tsx</path>
        <kind>page</kind>
        <symbol>SettingsPage</symbol>
        <lines>1-976</lines>
        <reason>Main settings page where push notification settings will be integrated as new tab or section</reason>
      </file>
      <file>
        <path>frontend/lib/api-client.ts</path>
        <kind>service</kind>
        <symbol>apiClient</symbol>
        <lines>1-300</lines>
        <reason>API client where push notification methods need to be added (getVapidPublicKey, subscribeToPush, etc.)</reason>
      </file>
      <file>
        <path>frontend/hooks/useCameras.ts</path>
        <kind>hook</kind>
        <symbol>useCameras</symbol>
        <lines>1-89</lines>
        <reason>Example hook pattern to follow for usePushNotifications hook</reason>
      </file>
      <file>
        <path>frontend/components/settings/AIProviders.tsx</path>
        <kind>component</kind>
        <symbol>AIProviders</symbol>
        <reason>Example settings component with toggle pattern to reference for PushNotificationSettings</reason>
      </file>
      <file>
        <path>frontend/components/settings/BackupRestore.tsx</path>
        <kind>component</kind>
        <symbol>BackupRestore</symbol>
        <reason>Example settings section card pattern</reason>
      </file>
      <file>
        <path>backend/app/api/v1/push.py</path>
        <kind>router</kind>
        <symbol>router</symbol>
        <lines>1-398</lines>
        <reason>Backend API endpoints that frontend will call - GET /vapid-public-key, POST /subscribe, DELETE /subscribe</reason>
      </file>
      <file>
        <path>backend/app/services/push_notification_service.py</path>
        <kind>service</kind>
        <symbol>PushNotificationService</symbol>
        <reason>Backend service for sending test notifications - can call send_notification() or broadcast_notification()</reason>
      </file>
    </code>
    <dependencies>
      <frontend>
        <package name="next" version="16.0.7" />
        <package name="react" version="19.2.0" />
        <package name="react-hook-form" version="^7.66.0" />
        <package name="@tanstack/react-query" version="^5.90.10" />
        <package name="sonner" version="^2.0.7" note="For toast notifications" />
        <package name="lucide-react" version="^0.553.0" note="For icons" />
        <package name="zod" version="^4.1.12" note="For schema validation" />
        <package name="@testing-library/react" version="^16.3.0" devDependency="true" />
        <package name="vitest" version="^4.0.15" devDependency="true" />
      </frontend>
      <backend>
        <package name="pywebpush" version=">=2.0.0" note="Already installed for P4-1.1" />
        <package name="py_vapid" version="latest" note="Already installed for P4-1.1" />
      </backend>
      <browser-apis>
        <api name="Notification API" mdn="https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API" />
        <api name="Push API" mdn="https://developer.mozilla.org/en-US/docs/Web/API/Push_API" />
        <api name="Service Worker" mdn="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" />
      </browser-apis>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="browser">Web Push requires HTTPS in production; localhost works for development</constraint>
    <constraint type="browser">Safari 16+ has limited Web Push support; Mobile Safari requires PWA installation first (Story P4-1.5)</constraint>
    <constraint type="architecture">Service worker must be registered for push subscriptions - will be added in Story P4-1.5; for now, show warning if not available</constraint>
    <constraint type="security">VAPID public key must match exactly between frontend and backend</constraint>
    <constraint type="ux">Permission requests should only occur after user action (click enable), not automatically</constraint>
    <constraint type="pattern">Follow existing shadcn/ui component patterns and hooks structure</constraint>
    <constraint type="testing">Use vitest with @testing-library/react for component tests</constraint>
    <constraint type="api">Use existing apiClient pattern with apiFetch wrapper for new push endpoints</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/v1/push/vapid-public-key</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/push/vapid-public-key → { public_key: string }</signature>
      <path>backend/app/api/v1/push.py:107-144</path>
    </interface>
    <interface>
      <name>POST /api/v1/push/subscribe</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/push/subscribe { endpoint: string, keys: { p256dh: string, auth: string }, user_agent?: string } → { id: string, endpoint: string, created_at: string }</signature>
      <path>backend/app/api/v1/push.py:147-260</path>
    </interface>
    <interface>
      <name>DELETE /api/v1/push/subscribe</name>
      <kind>REST endpoint</kind>
      <signature>DELETE /api/v1/push/subscribe { endpoint: string } → 204 No Content</signature>
      <path>backend/app/api/v1/push.py:263-318</path>
    </interface>
    <interface>
      <name>Notification.requestPermission()</name>
      <kind>Browser API</kind>
      <signature>Notification.requestPermission() → Promise&lt;'granted' | 'denied' | 'default'&gt;</signature>
      <path>Browser API</path>
    </interface>
    <interface>
      <name>PushManager.subscribe()</name>
      <kind>Browser API</kind>
      <signature>registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(vapidPublicKey) }) → Promise&lt;PushSubscription&gt;</signature>
      <path>Browser API via Service Worker</path>
    </interface>
    <interface>
      <name>PushSubscription.unsubscribe()</name>
      <kind>Browser API</kind>
      <signature>subscription.unsubscribe() → Promise&lt;boolean&gt;</signature>
      <path>Browser API</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend testing uses Vitest with @testing-library/react and jsdom. Component tests follow the pattern of rendering with mock providers, simulating user interactions with userEvent, and asserting on DOM output. Hook tests use renderHook from @testing-library/react. Browser APIs (Notification, PushManager) should be mocked in tests.
    </standards>
    <locations>
      <location>frontend/__tests__/</location>
      <location>frontend/components/**/__tests__/</location>
      <location>frontend/hooks/__tests__/</location>
    </locations>
    <ideas>
      <test ac="1">Test PushNotificationSettings renders enable/disable toggle correctly based on subscription state</test>
      <test ac="2">Test usePushNotifications hook calls Notification.requestPermission() when enable is triggered</test>
      <test ac="3">Test PermissionDeniedBanner renders when permission is 'denied' with correct guidance text</test>
      <test ac="4">Test successful subscription flow: permission granted → subscribe → show confirmation</test>
      <test ac="5">Test sendTestNotification() API call and toast feedback</test>
      <test ac="6">Test disable toggle calls unsubscribe API and updates UI state</test>
      <test ac="7">Test NotificationPreview component renders mock notification with correct structure</test>
      <test ac="8">Test loading states shown during async operations; test error state when API fails</test>
      <test ac="3">Test browser not supporting Push API shows appropriate fallback message</test>
    </ideas>
  </tests>
</story-context>
