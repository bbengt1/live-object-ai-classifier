<story-context id="p5-1-4-implement-motion-sensor-accessories" v="1.0">
  <metadata>
    <epicId>P5-1</epicId>
    <storyId>1.4</storyId>
    <title>Implement Motion Sensor Accessories</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p5-1-4-implement-motion-sensor-accessories.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>HomeKit user with Apple Home app</asA>
    <iWant>motion sensors that trigger when my ArgusAI cameras detect motion</iWant>
    <soThat>I can create HomeKit automations based on motion detection events</soThat>
    <tasks>
      <task id="1" ac="1,2,3">Verify Existing Implementation - Confirm CameraMotionSensor, trigger_motion(), and auto-reset timer implementation</task>
      <task id="2" ac="2">Validate Latency Requirements - Confirm fire-and-forget async pattern for less than 1s latency</task>
      <task id="3" ac="3">Review Configuration Defaults - DEFAULT_MOTION_RESET_SECONDS=30, DEFAULT_MAX_MOTION_DURATION=300</task>
      <task id="4" ac="2,4">Manual Testing Documentation - Test motion sensor in Apple Home app and automation triggering (deferred)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" status="implemented">Motion sensor accessory created for each enabled camera in ArgusAI</criterion>
    <criterion id="AC1" status="implemented">Motion sensor appears with correct name in Apple Home app (suffix " Motion")</criterion>
    <criterion id="AC1" status="implemented">Motion sensor accessory linked to Bridge (not standalone)</criterion>
    <criterion id="AC1" status="implemented">Motion sensor maintains persistent state across restarts</criterion>
    <criterion id="AC2" status="implemented">Event processor calls homekit_service.trigger_motion() on event creation</criterion>
    <criterion id="AC2" status="implemented">Fire-and-forget async task pattern ensures less than 1s from event to trigger call</criterion>
    <criterion id="AC2" status="manual-test">End-to-end latency verified under 2 seconds (requires manual testing)</criterion>
    <criterion id="AC2" status="implemented">Logging tracks timing for latency validation</criterion>
    <criterion id="AC3" status="implemented">Motion reset timer starts when motion triggered</criterion>
    <criterion id="AC3" status="implemented">Default timeout is 30 seconds (configurable via HOMEKIT_MOTION_RESET_SECONDS)</criterion>
    <criterion id="AC3" status="implemented">Rapid events reset timer, extending motion period</criterion>
    <criterion id="AC3" status="implemented">Max motion duration enforced (300 seconds default) to prevent stuck state</criterion>
    <criterion id="AC4" status="manual-test">HomeKit automation created with motion trigger (requires manual testing)</criterion>
    <criterion id="AC4" status="manual-test">Automation fires when ArgusAI detects motion (requires manual testing)</criterion>
    <criterion id="AC4" status="implemented">MotionDetected characteristic properly set via HAP-python</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-p5-1.md</path>
        <title>Epic P5-1 Technical Specification</title>
        <section>Story P5-1.4: Motion Sensor Accessories</section>
        <snippet>1. Motion sensor accessory created for each camera. 2. Sensor triggers within 2 seconds of ArgusAI motion detection. 3. State auto-resets after 3 seconds. 4. HomeKit automations can trigger on motion.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase5.md</path>
        <title>Phase 5 Epics</title>
        <section>Story P5-1.4: Implement Motion Sensor Accessories</section>
        <snippet>Create HomeKit Motion Sensor accessories that trigger on ArgusAI motion detection. Motion sensor accessory created for each camera, state resets after 3 seconds.</snippet>
      </doc>
      <doc>
        <path>docs/PRD-phase5.md</path>
        <title>Phase 5 PRD</title>
        <section>FR5: Motion Sensor</section>
        <snippet>Motion sensors must trigger on any motion detection event and reset automatically. Users can create HomeKit automations based on motion triggers.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/p5-1-3-create-camera-accessory-with-rtsp-to-hls-streaming.md</path>
        <title>Previous Story P5-1.3</title>
        <section>Dev Agent Record</section>
        <snippet>HomeKitCameraAccessory class implemented. Motion sensors already created for each camera in homekit_service.py start() method.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>backend/app/services/homekit_accessories.py</path>
        <kind>service</kind>
        <symbol>CameraMotionSensor</symbol>
        <lines>20-145</lines>
        <reason>Existing motion sensor accessory implementation from P4-6.1</reason>
      </file>
      <file>
        <path>backend/app/services/homekit_service.py</path>
        <kind>service</kind>
        <symbol>trigger_motion</symbol>
        <lines>504-562</lines>
        <reason>Motion triggering with auto-reset timer from P4-6.2</reason>
      </file>
      <file>
        <path>backend/app/services/homekit_service.py</path>
        <kind>service</kind>
        <symbol>_motion_reset_coroutine</symbol>
        <lines>616-632</lines>
        <reason>Auto-reset coroutine for motion state</reason>
      </file>
      <file>
        <path>backend/app/services/event_processor.py</path>
        <kind>service</kind>
        <symbol>_trigger_homekit_motion</symbol>
        <lines>1391-1442</lines>
        <reason>Event processor integration that triggers HomeKit on event detection</reason>
      </file>
      <file>
        <path>backend/app/config/homekit.py</path>
        <kind>config</kind>
        <symbol>HomekitConfig</symbol>
        <lines>224-287</lines>
        <reason>HomeKit configuration including motion_reset_seconds and max_motion_duration</reason>
      </file>
      <file>
        <path>backend/tests/test_services/test_homekit_motion.py</path>
        <kind>test</kind>
        <symbol>TestHomekitMotionTrigger</symbol>
        <lines>39-196</lines>
        <reason>Existing test suite for motion triggering, timer reset, and error handling</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="HAP-python" version=">=4.9.0">HomeKit Accessory Protocol implementation</package>
        <package name="zeroconf" version=">=0.131.0">mDNS/Bonjour for HomeKit discovery</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Motion sensor accessory uses HAP-python's preload_service("MotionSensor") pattern</constraint>
    <constraint type="pattern">Fire-and-forget async tasks via asyncio.create_task for non-blocking event processing</constraint>
    <constraint type="pattern">Motion state tracking via _motion_reset_tasks and _motion_start_times dictionaries</constraint>
    <constraint type="config">Default motion reset is 30 seconds (configurable via HOMEKIT_MOTION_RESET_SECONDS)</constraint>
    <constraint type="config">Maximum motion duration is 300 seconds to prevent stuck sensors</constraint>
    <constraint type="performance">Motion must propagate to HomeKit within 2 seconds of event detection</constraint>
    <constraint type="testing">Mock HAP-python classes for CI-friendly tests (no actual HomeKit connection)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>CameraMotionSensor</name>
      <kind>class</kind>
      <signature>CameraMotionSensor(driver, camera_id: str, name: str, manufacturer: str = "ArgusAI", model: str = "Motion Sensor")</signature>
      <path>backend/app/services/homekit_accessories.py</path>
    </interface>
    <interface>
      <name>trigger_motion</name>
      <kind>method</kind>
      <signature>trigger_motion(camera_id: str, event_id: Optional[int] = None) -> bool</signature>
      <path>backend/app/services/homekit_service.py</path>
    </interface>
    <interface>
      <name>clear_motion</name>
      <kind>method</kind>
      <signature>clear_motion(camera_id: str) -> bool</signature>
      <path>backend/app/services/homekit_service.py</path>
    </interface>
    <interface>
      <name>clear_all_motion</name>
      <kind>method</kind>
      <signature>clear_all_motion() -> None</signature>
      <path>backend/app/services/homekit_service.py</path>
    </interface>
    <interface>
      <name>register_camera_mapping</name>
      <kind>method</kind>
      <signature>register_camera_mapping(camera_id: str, mac_address: Optional[str] = None) -> None</signature>
      <path>backend/app/services/homekit_service.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Tests use pytest with pytest-asyncio for async test support. Mock HAP-python classes (MockCameraMotionSensor) for CI-friendly tests that don't require actual HomeKit hardware. Tests validate trigger behavior, timer reset logic, error resilience, and camera ID mapping for Protect cameras. Configuration tests verify environment variable loading.
    </standards>
    <locations>
      <location>backend/tests/test_services/test_homekit_motion.py</location>
      <location>backend/tests/test_services/test_homekit_service.py</location>
      <location>backend/tests/test_api/test_homekit.py</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test motion sensor creation during bridge start - verify sensor added to _sensors dict</idea>
      <idea ac="AC2">Test end-to-end timing from event creation to trigger_motion call - measure asyncio task latency</idea>
      <idea ac="AC2">Test fire-and-forget pattern doesn't block event processing</idea>
      <idea ac="AC3">Test motion reset after timeout - verify sensor.motion_detected goes False</idea>
      <idea ac="AC3">Test rapid events extend motion period - timer reset behavior</idea>
      <idea ac="AC3">Test max motion duration forces reset</idea>
      <idea ac="AC4">Manual test: Create HomeKit automation with motion trigger in Apple Home app</idea>
    </ideas>
  </tests>
</story-context>
