<story-context id="p4-2-2-home-assistant-discovery" v="1.0">
  <metadata>
    <epicId>P4-2</epicId>
    <storyId>2.2</storyId>
    <title>Home Assistant Discovery</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p4-2-2-home-assistant-discovery.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Home Assistant user</asA>
    <iWant>the AI classifier to automatically register sensors via MQTT Discovery</iWant>
    <soThat>my cameras and their AI-detected events appear in Home Assistant without manual configuration</soThat>
    <tasks>
      <task id="1" ac="1,3">Implement discovery config generation - Create MQTTDiscoveryService class</task>
      <task id="2" ac="1,5">Implement discovery publishing - publish to discovery prefix topics</task>
      <task id="3" ac="4">Implement sensor removal - empty payload on camera delete</task>
      <task id="4" ac="7">Add availability support - LWT and online/offline status</task>
      <task id="5" ac="6">Add discovery toggle - use existing discovery_enabled field</task>
      <task id="6" ac="1,5">Integrate with MQTTService - trigger discovery on connect</task>
      <task id="7" ac="1">Add API endpoint for manual discovery trigger</task>
      <task id="8" ac="all">Write tests - unit and integration</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Discovery config published to homeassistant/sensor/device_id/config on connect</criterion>
    <criterion id="2">Sensor entity appears in Home Assistant automatically after discovery publish</criterion>
    <criterion id="3">Device grouping shows all camera sensors together under one device</criterion>
    <criterion id="4">Sensor removal works when camera deleted (empty payload to discovery topic)</criterion>
    <criterion id="5">Discovery republished when MQTT reconnects after disconnection</criterion>
    <criterion id="6">Discovery can be disabled via configuration toggle</criterion>
    <criterion id="7">Entity availability published on connect/disconnect</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-p4-2.md</path>
        <title>Epic Technical Specification: Home Assistant Integration</title>
        <section>Story P4-2.2: Home Assistant Discovery</section>
        <snippet>Defines discovery config payload structure, discovery topic format, and acceptance criteria for sensor registration and removal.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase4.md</path>
        <title>Phase 4 Epics: Intelligent Context &amp; Smart Home Integration</title>
        <section>Epic P4-2: Home Assistant Integration</section>
        <snippet>Story P4-2.2 implements MQTT Discovery protocol, creates sensor entities for each camera, publishes device configuration on startup.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/p4-2-1-mqtt-client-implementation.md</path>
        <title>Story P4-2.1: MQTT Client Implementation</title>
        <section>Dev Agent Record</section>
        <snippet>Previous story created MQTTService, MQTTConfig model, integrations API. MQTTService has on_connect callback, discovery_enabled/discovery_prefix fields exist.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/app/services/mqtt_service.py</path>
        <kind>service</kind>
        <symbol>MQTTService</symbol>
        <lines>45-766</lines>
        <reason>Core MQTT service to extend with discovery. Has connect(), publish(), set_on_connect_callback() methods. Discovery should trigger via on_connect callback.</reason>
      </artifact>
      <artifact>
        <path>backend/app/services/mqtt_service.py</path>
        <kind>function</kind>
        <symbol>serialize_event_for_mqtt</symbol>
        <lines>769-856</lines>
        <reason>Event payload serializer - discovery payloads should follow similar structure for consistency.</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/mqtt_config.py</path>
        <kind>model</kind>
        <symbol>MQTTConfig</symbol>
        <lines>13-182</lines>
        <reason>MQTT configuration model with discovery_enabled, discovery_prefix, topic_prefix fields already present. No modifications needed.</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/v1/integrations.py</path>
        <kind>router</kind>
        <symbol>router</symbol>
        <lines>25-405</lines>
        <reason>Integrations API with placeholder for publish-discovery endpoint (lines 374-405). Needs full implementation.</reason>
      </artifact>
      <artifact>
        <path>backend/app/services/camera_service.py</path>
        <kind>service</kind>
        <symbol>CameraService</symbol>
        <lines>30-100</lines>
        <reason>Camera service to hook for discovery removal on camera delete. Need to add MQTT discovery removal hook.</reason>
      </artifact>
      <artifact>
        <path>backend/tests/test_services/test_mqtt_service.py</path>
        <kind>test</kind>
        <symbol>TestMQTTServiceInit</symbol>
        <lines>1-50</lines>
        <reason>Existing MQTT tests - add discovery tests following same patterns (pytest, unittest.mock, AsyncMock).</reason>
      </artifact>
      <artifact>
        <path>backend/tests/test_api/test_integrations.py</path>
        <kind>test</kind>
        <symbol>test_integrations</symbol>
        <reason>Existing integrations API tests - add publish-discovery endpoint tests.</reason>
      </artifact>
    </code>

    <dependencies>
      <python>
        <package name="paho-mqtt" version=">=2.0.0">MQTT client library (already installed)</package>
        <package name="fastapi" version="==0.115.0">Web framework for API endpoints</package>
        <package name="sqlalchemy" version=">=2.0.36">ORM for database models</package>
        <package name="pytest" version="==7.4.3">Testing framework</package>
        <package name="pytest-asyncio" version="==0.21.1">Async test support</package>
      </python>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>MQTTService.publish</name>
      <kind>async method</kind>
      <signature>async def publish(self, topic: str, payload: dict, qos: Optional[int] = None, retain: Optional[bool] = None) -> bool</signature>
      <path>backend/app/services/mqtt_service.py:290</path>
    </interface>
    <interface>
      <name>MQTTService.set_on_connect_callback</name>
      <kind>method</kind>
      <signature>def set_on_connect_callback(self, callback: Callable[[], None]) -> None</signature>
      <path>backend/app/services/mqtt_service.py:106</path>
    </interface>
    <interface>
      <name>MQTTService.is_connected</name>
      <kind>property</kind>
      <signature>@property def is_connected(self) -> bool</signature>
      <path>backend/app/services/mqtt_service.py:86</path>
    </interface>
    <interface>
      <name>GET /api/v1/integrations/mqtt/config</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/integrations/mqtt/config -> MQTTConfigResponse</signature>
      <path>backend/app/api/v1/integrations.py:190</path>
    </interface>
    <interface>
      <name>POST /api/v1/integrations/mqtt/publish-discovery</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/integrations/mqtt/publish-discovery -> PublishDiscoveryResponse</signature>
      <path>backend/app/api/v1/integrations.py:374</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="tech-spec">MQTT publishing must not block event processing (&lt;100ms latency target)</constraint>
    <constraint source="tech-spec">Connection failures must not crash the application</constraint>
    <constraint source="tech-spec">Auto-reconnect must restore publishing without manual intervention</constraint>
    <constraint source="architecture">Discovery messages must use QoS 1 and retain=true for reliability</constraint>
    <constraint source="architecture">Sensor removal uses empty payload ("") to discovery topic per HA spec</constraint>
    <constraint source="tech-spec">Discovery prefix configurable (default: "homeassistant")</constraint>
    <constraint source="tech-spec">Topic prefix configurable (default: "liveobject")</constraint>
    <constraint source="ha-spec">Discovery topic format: {discovery_prefix}/sensor/liveobject_{camera_id}_event/config</constraint>
    <constraint source="ha-spec">LWT (Last Will and Testament) must publish "offline" on unexpected disconnect</constraint>
  </constraints>

  <tests>
    <standards>
      Tests use pytest with pytest-asyncio for async code. Mock paho.mqtt.client for unit tests.
      Use unittest.mock.MagicMock, AsyncMock, and patch decorators. Follow existing patterns in
      test_mqtt_service.py. Integration tests may use a real MQTT broker or mock broker.
      Target 80% code coverage for new code.
    </standards>
    <locations>
      <location>backend/tests/test_services/test_mqtt_service.py</location>
      <location>backend/tests/test_api/test_integrations.py</location>
    </locations>
    <ideas>
      <idea ac="1">Test generate_sensor_config returns valid HA discovery payload with all required fields</idea>
      <idea ac="1">Test discovery topic follows format: {discovery_prefix}/sensor/liveobject_{id}_event/config</idea>
      <idea ac="3">Test device info includes identifiers, name, manufacturer, model, sw_version</idea>
      <idea ac="4">Test remove_discovery_config publishes empty string to discovery topic</idea>
      <idea ac="5">Test discovery republished after reconnect via on_connect callback</idea>
      <idea ac="6">Test discovery skipped when discovery_enabled=false</idea>
      <idea ac="7">Test LWT configured before connect with "offline" payload</idea>
      <idea ac="7">Test "online" published to status topic after successful connect</idea>
    </ideas>
  </tests>
</story-context>
