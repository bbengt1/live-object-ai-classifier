# Story P11-1.3: Create Settings UI for Tunnel Configuration

Status: done

## Story

As a user,
I want to configure Cloudflare Tunnel from the Settings page,
so that I can enable remote access without editing config files.

## Acceptance Criteria

1. AC-1.3.1: Settings > Integrations tab includes Tunnel section
2. AC-1.3.2: Enable/disable toggle for tunnel
3. AC-1.3.3: Secure input field for tunnel token (password type with show/hide toggle)
4. AC-1.3.4: Status indicator shows connection state (disconnected, connecting, connected, error)
5. AC-1.3.5: Test connection button validates setup and shows feedback

## Tasks / Subtasks

- [x] Task 1: Create TunnelSettings component (AC: 1.3.1, 1.3.2, 1.3.3, 1.3.4, 1.3.5)
  - [x] 1.1: Create `frontend/components/settings/TunnelSettings.tsx` component
  - [x] 1.2: Add enable/disable toggle with immediate save to backend
  - [x] 1.3: Add secure token input field with show/hide password toggle
  - [x] 1.4: Add status indicator badge (disconnected/connecting/connected/error)
  - [x] 1.5: Add Test Connection button with loading state and toast feedback
  - [x] 1.6: Display uptime, last connected, and reconnect count when connected
  - [x] 1.7: Display error message when in error state
- [x] Task 2: Integrate TunnelSettings into Settings page (AC: 1.3.1)
  - [x] 2.1: Import TunnelSettings in `frontend/app/settings/page.tsx`
  - [x] 2.2: Add TunnelSettings to Integrations tab alongside MQTTSettings and HomekitSettings
  - [x] 2.3: Wrap with ErrorBoundary for resilient error handling
- [x] Task 3: Add API client methods for tunnel operations
  - [x] 3.1: Add `getTunnelStatus()` method to api-client.ts
  - [x] 3.2: Add `startTunnel(token?: string)` method to api-client.ts
  - [x] 3.3: Add `stopTunnel()` method to api-client.ts
- [x] Task 4: Write component tests (AC: All)
  - [x] 4.1: Create `frontend/__tests__/components/settings/TunnelSettings.test.tsx`
  - [x] 4.2: Test toggle enable/disable behavior
  - [x] 4.3: Test status indicator displays correctly for each state
  - [x] 4.4: Test Test Connection button shows loading and success/error feedback

## Dev Notes

### Architecture Pattern
This component follows the pattern established by similar settings components:
- `MQTTSettings.tsx` - Integration toggle with form fields
- `HomekitSettings.tsx` - Status display with diagnostics
- `PushNotificationSettings.tsx` - Toggle with status indicators

### Backend Endpoints (Already Implemented in P11-1.1, P11-1.2)
The following endpoints are available from `backend/app/api/v1/system.py`:
- `GET /api/v1/system/tunnel/status` - Returns TunnelStatusResponse
- `POST /api/v1/system/tunnel/start` - Starts tunnel with optional token
- `POST /api/v1/system/tunnel/stop` - Stops tunnel

### TunnelStatusResponse Schema
```typescript
interface TunnelStatus {
  status: 'disconnected' | 'connecting' | 'connected' | 'error';
  is_connected: boolean;
  is_running: boolean;
  hostname: string | null;
  error: string | null;
  enabled: boolean;
  uptime_seconds: number;
  last_connected: string | null;
  reconnect_count: number;
}
```

### UI Components to Use
- `Switch` from shadcn/ui for enable/disable toggle
- `Input` with `type="password"` for token field
- `Button` with eye icon for show/hide toggle
- `Badge` or status dot for connection state indicator
- `toast` from sonner for feedback messages
- `Loader2` for loading spinner during connection test

### Status Badge Colors
- `disconnected`: gray (`bg-gray-400`)
- `connecting`: yellow (`bg-yellow-500`) with pulse animation
- `connected`: green (`bg-green-500`)
- `error`: red (`bg-red-500`)

### Testing Standards
- Use Vitest + React Testing Library (established in P5-3.3)
- Mock API calls with MSW or jest.fn()
- Test all status states and user interactions

### Project Structure Notes
- Component path: `frontend/components/settings/TunnelSettings.tsx`
- Test path: `frontend/__tests__/components/settings/TunnelSettings.test.tsx`
- Settings page: `frontend/app/settings/page.tsx`
- API client: `frontend/lib/api-client.ts`

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-1.md#APIs-and-Interfaces]
- [Source: docs/epics-phase11.md#P11-1.3]
- [Source: backend/app/api/v1/system.py:2041-2265] - Tunnel API endpoints
- [Source: backend/app/services/tunnel_service.py] - TunnelService implementation
- [Source: frontend/components/settings/MQTTSettings.tsx] - Similar pattern reference
- [Source: frontend/components/settings/HomekitSettings.tsx] - Status display reference

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

- All acceptance criteria implemented and tested
- 28 component tests pass covering all ACs
- Frontend build successful
- TunnelSettings component follows established patterns from MQTTSettings and HomekitSettings

### File List

- frontend/components/settings/TunnelSettings.tsx (new)
- frontend/__tests__/components/settings/TunnelSettings.test.tsx (new)
- frontend/lib/api-client.ts (modified - added tunnel API methods and types)
- frontend/app/settings/page.tsx (modified - integrated TunnelSettings)
- docs/sprint-artifacts/P11-1-3.md (new)

