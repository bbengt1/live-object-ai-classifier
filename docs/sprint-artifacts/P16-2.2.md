# Story P16-2.2: Implement Backend Stream Proxy Service

Status: done

## Story

As a **backend developer**,
I want **a service to proxy camera streams**,
So that **the frontend can display live video**.

## Acceptance Criteria

1. **Given** a valid Protect controller and camera
   **When** I call `StreamProxyService.get_stream_url(controller_id, camera_id)`
   **Then** I receive stream connection info: url, type (websocket/mjpeg), quality options

2. **Given** the chosen streaming approach (MJPEG via WebSocket from P16-2.1)
   **When** the proxy endpoint is called
   **Then** video data is streamed to the client with <3 second latency

3. **And** `GET /api/v1/cameras/{id}/stream/info` returns stream info (url, quality options)
   **And** `WS /api/v1/cameras/{id}/stream` establishes WebSocket for MJPEG frames
   **And** `GET /api/v1/cameras/{id}/stream/snapshot` returns current frame JPEG
   **And** authentication is required for all stream endpoints
   **And** concurrent stream limit is enforced (default 10, configurable via STREAM_MAX_CONCURRENT)

## Tasks / Subtasks

- [x] Task 1: Create StreamProxyService (AC: 1, 2)
  - [x] Create `backend/app/services/stream_proxy_service.py`
  - [x] Implement RTSP connection via OpenCV/PyAV
  - [x] Implement frame extraction at configurable FPS (5/10/15)
  - [x] Implement JPEG encoding with quality levels (Low/Medium/High)
  - [x] Add stream sharing (1 RTSP connection, N WebSocket clients)

- [x] Task 2: Create StreamManager for concurrency control (AC: 3)
  - [x] Track active streams per camera
  - [x] Implement concurrent stream limit (STREAM_MAX_CONCURRENT env var)
  - [x] Handle client connect/disconnect
  - [x] Implement graceful stream shutdown

- [x] Task 3: Create WebSocket streaming endpoint (AC: 2, 3)
  - [x] Add `WS /api/v1/cameras/{id}/stream` endpoint
  - [x] Implement JWT authentication for WebSocket
  - [x] Send binary JPEG frames to clients
  - [x] Handle quality change requests via WebSocket messages
  - [x] Implement ping/pong for connection health

- [x] Task 4: Create REST endpoints for stream info (AC: 3)
  - [x] Add `GET /api/v1/cameras/{id}/stream/info` endpoint
  - [x] Add `GET /api/v1/cameras/{id}/stream/snapshot` endpoint
  - [x] Return stream URL, type, available quality options

- [x] Task 5: Add configuration and error handling (AC: 3)
  - [x] Add STREAM_MAX_CONCURRENT to settings
  - [x] Handle camera offline gracefully
  - [x] Handle RTSP connection failures with retry
  - [x] Log stream metrics (active count, frame rate, errors)

- [x] Task 6: Write tests (AC: all)
  - [x] Unit tests for StreamProxyService
  - [x] Unit tests for StreamManager (embedded in StreamProxyService)
  - [x] Integration tests for WebSocket endpoint
  - [x] Test concurrent stream limiting

## Dev Notes

### Technical Context

- **Epic**: P16-2 - Live Camera Streaming
- **GitHub Issue**: #354
- **FRs Covered**: FR16, FR17, FR21
- **Prerequisites**: P16-2.1 (Design Document) ✅

### Implementation Approach (from P16-2.1 Design)

**MJPEG via WebSocket** is the chosen approach:
- RTSP → OpenCV/PyAV decode → JPEG encode → WebSocket binary frames
- ~100ms end-to-end latency (well under 3s requirement)
- Universal browser support

### Quality Levels

| Quality | Resolution | FPS | JPEG Quality | Bandwidth |
|---------|------------|-----|--------------|-----------|
| Low | 640x360 | 5 | 70 | ~1.2 Mbps |
| Medium | 1280x720 | 10 | 80 | ~4.0 Mbps |
| High | 1920x1080 | 15 | 90 | ~9.6 Mbps |

### Architecture

```
Camera (RTSP) → StreamProxyService → StreamManager → WebSocket Clients
                     │                     │
                     ├── Frame buffer      ├── Track active streams
                     ├── JPEG encode       ├── Enforce limits
                     └── Quality control   └── Client lifecycle
```

### Key Components

1. **StreamProxyService** (`stream_proxy_service.py`)
   - Singleton service managing all camera streams
   - Uses existing `camera_service.py` patterns for RTSP
   - Maintains frame buffer for instant client joins

2. **StreamManager** (embedded or separate)
   - Tracks `{camera_id: Set[client_id]}`
   - Enforces `STREAM_MAX_CONCURRENT` limit
   - Metrics: active_streams, total_clients

3. **WebSocket Endpoint** (`/api/v1/cameras/{id}/stream`)
   - Binary JPEG frames (no base64 overhead)
   - JSON control messages (quality change, ping)
   - JWT auth via query param or first message

### Existing Code to Leverage

- `backend/app/services/camera_service.py` - RTSP connection patterns
- `backend/app/services/snapshot_service.py` - JPEG encoding
- `backend/app/core/security.py` - JWT authentication
- `backend/app/api/v1/events.py` - WebSocket patterns (if any exist)

### Environment Variables

```env
STREAM_MAX_CONCURRENT=10  # Max concurrent streams server-wide
STREAM_DEFAULT_QUALITY=medium  # Default quality level
STREAM_FRAME_BUFFER_SIZE=5  # Frames to buffer for new clients
```

### Project Structure Notes

- New file: `backend/app/services/stream_proxy_service.py`
- Modify: `backend/app/api/v1/cameras.py` (add stream endpoints)
- Config: Add stream settings to `backend/app/core/config.py`

### References

- [Source: docs/sprint-artifacts/p16-2-1-streaming-design.md#Section-3]
- [Source: docs/sprint-artifacts/p16-2-1-streaming-design.md#Section-5]
- [Source: docs/epics-phase16.md#Story-P16-2.2]
- [Source: backend/app/services/camera_service.py - RTSP patterns]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

1. Created `StreamProxyService` singleton with full RTSP streaming support
2. Implemented quality levels: Low (640x360@5fps), Medium (720p@10fps), High (1080p@15fps)
3. Added WebSocket endpoint with binary JPEG frame streaming and JSON control messages
4. Stream sharing: Single RTSP connection serves multiple WebSocket clients
5. Concurrent limit enforcement (default 10, configurable via STREAM_MAX_CONCURRENT)
6. Graceful shutdown and client lifecycle management
7. Added configuration settings for streaming in `config.py`
8. Added Pydantic schemas for streaming API responses
9. Unit tests created for all core functionality (29 test cases)

### File List

- `backend/app/services/stream_proxy_service.py` (NEW) - Main streaming service
- `backend/app/api/v1/cameras.py` (MODIFIED) - Added streaming endpoints
- `backend/app/schemas/camera.py` (MODIFIED) - Added streaming schemas
- `backend/app/core/config.py` (MODIFIED) - Added streaming settings
- `backend/tests/test_services/test_stream_proxy_service.py` (NEW) - Unit tests

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-01 | Story created | Claude Code |
