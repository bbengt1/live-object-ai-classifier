<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>f2</epicId>
    <storyId>f2.1.2</storyId>
    <title>Detection Zone Drawing UI</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/f2-1-2-detection-zone-drawing-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to draw polygon detection zones on the camera preview</iWant>
    <soThat>I can configure motion detection to only trigger in specific areas of the camera view, reducing false positives from irrelevant regions</soThat>
    <tasks>
      <task id="1" acs="1,2,6">Create Detection Zone Canvas Component - DetectionZoneDrawer with HTML5 Canvas, polygon drawing, coordinate normalization, vertex tracking, undo functionality</task>
      <task id="2" acs="6">Zone Preset Templates - Rectangle, Triangle, L-shape templates with positioning</task>
      <task id="3" acs="3,4">Zone List and Management UI - DetectionZoneList component with enable/disable, delete, inline name editing</task>
      <task id="4" acs="1,2,3">Camera Preview Integration - Canvas preview, zone overlays, draw mode toggle, responsive sizing</task>
      <task id="5" acs="2,4">API Integration for Zones - detection_zones field, PUT/GET endpoints, validation, error handling</task>
      <task id="6" acs="1,2">Polygon Geometry Validation - Minimum 3 vertices, Zod schema, bounds checking, auto-close polygon</task>
      <task id="7" acs="1,3,6">Visual Styling and UX Polish - Polygon overlays, hover effects, distinct colors, zone labels, mobile-responsive</task>
      <task id="8" acs="all">Testing - Manual testing of drawing, presets, management, persistence, responsiveness</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" priority="must">
      <title>Polygon Zone Drawing Interface</title>
      <description>Canvas overlay with click handlers, minimum 3 vertices, double-click/Finish to close, polygon displayed with lines and semi-transparent fill</description>
    </criterion>
    <criterion id="2" priority="must">
      <title>Zone Coordinate Normalization</title>
      <description>Coordinates normalized to 0-1 scale, saved to backend API, renders correctly when preview resized</description>
    </criterion>
    <criterion id="3" priority="must">
      <title>Multiple Zone Support</title>
      <description>Display all zones with visual overlays, add up to 10 zones per camera, unique names and identifiers</description>
    </criterion>
    <criterion id="4" priority="must">
      <title>Zone Management</title>
      <description>Enable/disable toggles, delete with confirmation, inline name editing, immediate persistence to backend</description>
    </criterion>
    <criterion id="5" priority="must">
      <title>Point-in-Polygon Validation</title>
      <description>Backend filters motion using point-in-polygon geometry, motion outside zones ignored, motion within enabled zones triggers event</description>
    </criterion>
    <criterion id="6" priority="should">
      <title>Zone Drawing UX Enhancements</title>
      <description>Vertex count indicator, Undo Last Vertex button, highlighted first vertex, preset templates (Rectangle, Triangle, L-shape)</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-f2.md</path>
        <title>Epic F2 Technical Specification - Motion Detection</title>
        <section>Detection Zones (DECISION-1)</section>
        <snippet>Polygon-based detection zones with point-in-polygon filtering. Zones stored as JSON array with vertices normalized to 0-1 scale. Backend DetectionZoneManager service handles ray casting algorithm. Max 10 zones per camera to limit computational cost.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/f2-1-1-motion-detection-ui-components.md</path>
        <title>Story F2.1-1: Motion Detection UI Components</title>
        <section>Frontend Patterns Established</section>
        <snippet>shadcn/ui component patterns, React Hook Form integration, Zod validation, TypeScript type safety, MotionSettingsSection reusable component model. Multi-layer validation (Zod + React Hook Form + HTML attributes).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Frontend Stack and Implementation Patterns</section>
        <snippet>Next.js 15 App Router, TypeScript 5, Tailwind CSS, shadcn/ui components, React Hook Form, Zod validation. Naming conventions: PascalCase components, camelCase functions, PROJECT-RELATIVE paths only.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>F2.2: Motion Detection Zones</section>
        <snippet>User should define active detection zones. Draw rectangle zones on camera preview, multiple zones per camera, enable/disable zones independently, ignore motion outside defined zones. UI allows drawing zones with mouse/touch.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/components/cameras/MotionSettingsSection.tsx</path>
        <kind>component</kind>
        <symbol>MotionSettingsSection</symbol>
        <lines>1-251</lines>
        <reason>Reference pattern for motion config UI component - demonstrates shadcn/ui integration, tooltips, form field structure</reason>
      </artifact>
      <artifact>
        <path>frontend/components/cameras/CameraForm.tsx</path>
        <kind>component</kind>
        <symbol>CameraForm</symbol>
        <lines>1-400+</lines>
        <reason>Parent component where DetectionZoneDrawer will be integrated. Shows React Hook Form setup, defaultValues pattern, form submission handling</reason>
      </artifact>
      <artifact>
        <path>frontend/types/camera.ts</path>
        <kind>types</kind>
        <symbol>ICamera, ICameraCreate, ICameraUpdate</symbol>
        <lines>24-71</lines>
        <reason>Extend these interfaces with detection_zones field (array of DetectionZone objects)</reason>
      </artifact>
      <artifact>
        <path>frontend/lib/validations/camera.ts</path>
        <kind>validation</kind>
        <symbol>cameraFormSchema</symbol>
        <lines>11-61</lines>
        <reason>Add Zod schema for DetectionZone validation - minimum 3 vertices, coordinates 0-1 range, required fields</reason>
      </artifact>
      <artifact>
        <path>backend/app/schemas/motion.py</path>
        <kind>schema</kind>
        <symbol>DetectionZone</symbol>
        <lines>173-214</lines>
        <reason>Backend Pydantic schema for detection zones. Frontend TypeScript interface must match this structure exactly. Validates polygon vertices and auto-closes polygon.</reason>
      </artifact>
      <artifact>
        <path>backend/app/services/detection_zone_manager.py</path>
        <kind>service</kind>
        <symbol>DetectionZoneManager</symbol>
        <lines>entire file</lines>
        <reason>Backend service handling point-in-polygon filtering using ray casting. Frontend zones will be validated by this service when saved.</reason>
      </artifact>
    </code>
    <dependencies>
      <frontend>
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
        <package name="next" version="16.0.3" />
        <package name="typescript" version="^5" />
        <package name="react-hook-form" version="^7.66.0" />
        <package name="zod" version="^4.1.12" />
        <package name="@hookform/resolvers" version="^5.2.2" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" />
        <package name="@radix-ui/react-label" version="^2.1.8" />
        <package name="@radix-ui/react-select" version="^2.2.6" />
        <package name="@radix-ui/react-slider" version="^1.3.6" />
        <package name="@radix-ui/react-tooltip" version="^1.2.8" />
        <package name="lucide-react" version="^0.553.0" />
        <package name="clsx" version="^2.1.1" />
        <package name="tailwind-merge" version="^3.4.0" />
      </frontend>
      <backend>
        <package name="fastapi" version="0.115.0" />
        <package name="pydantic" version=">=2.10.0" />
        <package name="opencv-python" version=">=4.12.0" />
        <package name="sqlalchemy" version=">=2.0.36" />
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <description>Use HTML5 Canvas API for polygon drawing (no external libraries like react-konva)</description>
      <rationale>Zero dependencies, full control, smaller bundle size per tech spec DECISION-1</rationale>
    </constraint>
    <constraint type="data-model">
      <description>Polygon vertices must be normalized to 0-1 scale relative to canvas dimensions</description>
      <rationale>Responsive display - zones scale correctly when preview resized</rationale>
    </constraint>
    <constraint type="validation">
      <description>Minimum 3 vertices required for valid polygon, coordinates must be in range 0 ≤ x,y ≤ 1</description>
      <rationale>Backend DetectionZone Pydantic schema enforces these constraints</rationale>
    </constraint>
    <constraint type="performance">
      <description>Max 10 zones per camera to limit computational cost</description>
      <rationale>Point-in-polygon check adds ~5-10ms overhead per zone, must stay within <100ms motion detection budget</rationale>
    </constraint>
    <constraint type="ui-patterns">
      <description>Use shadcn/ui components (Dialog for delete confirmation, Card for zone list), React Hook Form for state management</description>
      <rationale>Consistency with F2.1-1 Motion Settings patterns, established in previous story</rationale>
    </constraint>
    <constraint type="testing">
      <description>Manual testing only (no automated frontend tests yet per Epic F2 retrospective)</description>
      <rationale>Frontend test infrastructure deferred to future epic, comprehensive manual test checklist required</rationale>
    </constraint>
    <constraint type="mobile-responsive">
      <description>Drawing interface must support touch events for mobile/tablet use</description>
      <rationale>PRD NFR3.3 mobile responsiveness requirement, touch-friendly controls</rationale>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PUT /api/v1/cameras/{id}/motion/config</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/v1/cameras/{camera_id}/motion/config - Request: MotionConfigUpdate with detection_zones array - Response: 200 OK + updated camera config</signature>
      <path>backend/app/api/v1/cameras.py</path>
      <description>Update motion detection configuration including detection zones. Frontend sends array of DetectionZone objects with normalized coordinates.</description>
    </interface>
    <interface>
      <name>GET /api/v1/cameras/{id}/motion/config</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/cameras/{camera_id}/motion/config - Response: 200 OK + MotionConfigResponse with detection_zones array</signature>
      <path>backend/app/api/v1/cameras.py</path>
      <description>Retrieve current motion detection configuration including zones. Frontend renders zones on canvas preview.</description>
    </interface>
    <interface>
      <name>DetectionZone (TypeScript)</name>
      <kind>TypeScript interface</kind>
      <signature>interface IDetectionZone { id: string; name: string; vertices: Array&lt;{x: number; y: number}&gt;; enabled: boolean; }</signature>
      <path>frontend/types/camera.ts (to be added)</path>
      <description>Frontend TypeScript interface mirroring backend Pydantic DetectionZone schema. Vertices normalized to 0-1 scale.</description>
    </interface>
    <interface>
      <name>detectionZoneSchema (Zod)</name>
      <kind>Zod validation schema</kind>
      <signature>z.object({ id: z.string(), name: z.string().min(1).max(100), vertices: z.array(z.object({ x: z.number().min(0).max(1), y: z.number().min(0).max(1) })).min(3), enabled: z.boolean() })</signature>
      <path>frontend/lib/validations/camera.ts (to be added)</path>
      <description>Client-side validation for detection zones. Enforces minimum 3 vertices, coordinate bounds, required fields.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph>Manual testing required for all frontend components per Epic F2 retrospective decision. Automated frontend tests deferred to future epic. Test coverage includes: polygon drawing with various vertex counts, preset templates (Rectangle, Triangle, L-shape), zone management (enable/disable, delete, rename), coordinate normalization validation (resize canvas to verify zones scale), API persistence (reload page, verify zones persist), mobile responsiveness (touch events), browser compatibility (Chrome, Firefox, Safari, Edge). Use comprehensive manual test checklist in Task 8.</paragraph>
    </standards>
    <locations>
      <location>frontend/components/cameras/__tests__/ (future - not yet created)</location>
      <location>Manual testing checklist in story Task 8 (current approach)</location>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Test polygon drawing: Create triangle (3 vertices), rectangle (4 vertices), complex L-shape (6 vertices). Verify lines connect, fill is semi-transparent, double-click closes polygon.</description>
      </idea>
      <idea ac="2">
        <description>Test coordinate normalization: Draw zone at specific coordinates, resize canvas/browser window, verify zone scales proportionally. Check normalized values are 0-1 range in browser dev tools network tab.</description>
      </idea>
      <idea ac="3">
        <description>Test multiple zones: Add 3-4 zones with different shapes, verify distinct colors, unique names, visual identifiers. Attempt to add 11th zone, verify max limit enforced with error message.</description>
      </idea>
      <idea ac="4">
        <description>Test zone management: Toggle zone enabled/disabled, verify visual changes (reduced opacity when disabled). Delete zone, verify confirmation dialog appears. Edit zone name inline, verify persistence after save.</description>
      </idea>
      <idea ac="5">
        <description>Test point-in-polygon validation: Create zone covering 50% of frame, trigger motion detection (if backend available), verify motion outside zone is ignored. Backend integration test.</description>
      </idea>
      <idea ac="6">
        <description>Test UX enhancements: Verify vertex count indicator updates ("3 vertices - click to add more"). Test Undo Last Vertex button. Verify first vertex highlighted. Test preset templates load correct shapes.</description>
      </idea>
      <idea ac="all">
        <description>Cross-browser testing: Test in Chrome, Firefox, Safari, Edge. Verify canvas rendering, touch events work on tablets/phones. Test with keyboard navigation for accessibility.</description>
      </idea>
    </ideas>
  </tests>
</story-context>
