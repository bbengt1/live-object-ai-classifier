<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>P6-1</epicId>
    <storyId>P6-1.2</storyId>
    <title>Add React.memo to CameraPreview Component</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p6-1-2-add-react-memo-to-camerapreview-component.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user with many cameras</asA>
    <iWant>the camera list to render efficiently without unnecessary re-renders</iWant>
    <soThat>the UI remains responsive when navigating and filtering cameras</soThat>
    <tasks>
      <task id="1" status="pending">Add React.memo wrapper to CameraPreview (AC: 1)
        <subtask id="1.1">Import `memo` from React</subtask>
        <subtask id="1.2">Wrap the `CameraPreview` function component with `memo()`</subtask>
        <subtask id="1.3">Export the memoized component</subtask>
      </task>
      <task id="2" status="pending">Implement custom comparison function (AC: 2, 3)
        <subtask id="2.1">Create `arePropsEqual` function comparing camera.id, camera.updated_at, and onDelete reference</subtask>
        <subtask id="2.2">Compare key camera fields: name, is_enabled, frame_rate, motion_sensitivity, is_doorbell, source_type, protect_camera_type</subtask>
        <subtask id="2.3">Pass comparison function as second argument to `memo()`</subtask>
      </task>
      <task id="3" status="pending">Verify behavior (AC: 3, 4)
        <subtask id="3.1">Add console.log in dev mode to verify render count (remove before commit)</subtask>
        <subtask id="3.2">Verify filtering by source type doesn't cause extra renders</subtask>
        <subtask id="3.3">Verify delete handler changes don't cause unnecessary re-renders</subtask>
      </task>
      <task id="4" status="pending">Write tests (All ACs)
        <subtask id="4.1">Add test verifying component renders correctly with memoization</subtask>
        <subtask id="4.2">Add test verifying component doesn't re-render when parent re-renders with same props</subtask>
        <subtask id="4.3">Add test verifying component re-renders when camera data changes</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">CameraPreview component wrapped with React.memo</criterion>
    <criterion id="2">Custom comparison function for props (camera object and onDelete callback)</criterion>
    <criterion id="3">Re-renders only when camera data or delete handler changes</criterion>
    <criterion id="4">No visual regression in camera list display</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics-phase6.md</path>
        <title>Phase 6 Epics</title>
        <section>Epic P6-1: Camera Setup &amp; Performance</section>
        <snippet>Story P6-1.2 defines React.memo optimization for CameraPreview component with custom comparison function.</snippet>
      </doc>
      <doc>
        <path>docs/backlog.md</path>
        <title>Project Backlog</title>
        <section>IMP-005</section>
        <snippet>Camera List Optimizations: Add React.memo for CameraPreview component, virtual scrolling for large lists.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/implementation-patterns.md</path>
        <title>Implementation Patterns</title>
        <section>Frontend Hook Pattern</section>
        <snippet>React components use PascalCase naming, hooks use `use` prefix, TypeScript interfaces prefixed with `I`.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>frontend/components/cameras/CameraPreview.tsx</path>
        <kind>component</kind>
        <symbol>CameraPreview</symbol>
        <lines>41-147</lines>
        <reason>Target component to wrap with React.memo - displays camera info card with source badge, status, action buttons</reason>
      </file>
      <file>
        <path>frontend/components/cameras/CameraPreviewCard.tsx</path>
        <kind>component</kind>
        <symbol>CameraPreviewCard</symbol>
        <lines>78-204</lines>
        <reason>Reference implementation - already uses memo() wrapper pattern at line 78</reason>
      </file>
      <file>
        <path>frontend/app/cameras/page.tsx</path>
        <kind>page</kind>
        <symbol>CamerasPage</symbol>
        <lines>193-199</lines>
        <reason>Parent component that renders CameraPreview in a map loop over filteredCameras</reason>
      </file>
      <file>
        <path>frontend/components/cameras/CameraGrid.tsx</path>
        <kind>component</kind>
        <symbol>CameraGrid</symbol>
        <lines>192-199</lines>
        <reason>Another usage of camera components in grid - shows CameraPreviewCard with memo</reason>
      </file>
      <file>
        <path>frontend/types/camera.ts</path>
        <kind>types</kind>
        <symbol>ICamera</symbol>
        <lines>83-109</lines>
        <reason>TypeScript interface for camera props - defines fields for comparison function</reason>
      </file>
      <file>
        <path>frontend/__tests__/test-utils.tsx</path>
        <kind>test-utils</kind>
        <symbol>mockCamera</symbol>
        <lines>95-105</lines>
        <reason>Test utilities with mockCamera factory for creating test fixtures</reason>
      </file>
    </code>
    <dependencies>
      <npm>
        <package name="react" version="19.2.0">Core React library with memo, useState, useMemo hooks</package>
        <package name="@testing-library/react" version="^16.3.0">Testing library for React components</package>
        <package name="@testing-library/user-event" version="^14.6.1">User event simulation for tests</package>
        <package name="vitest" version="^4.0.15">Test runner framework</package>
        <package name="@tanstack/react-query" version="^5.90.10">Data fetching library used in parent components</package>
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use named function syntax with memo: `export const CameraPreview = memo(function CameraPreview(...) {...}, arePropsEqual)`</constraint>
    <constraint type="pattern">Follow existing CameraPreviewCard.tsx memo pattern at line 78</constraint>
    <constraint type="performance">Custom comparison must check all fields that affect visual output to prevent stale renders</constraint>
    <constraint type="testing">Tests must verify memoization prevents re-renders using React Testing Library</constraint>
    <constraint type="visual">No visual regression - component must render identically before and after memoization</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>CameraPreviewProps</name>
      <kind>TypeScript interface</kind>
      <signature>interface CameraPreviewProps { camera: ICamera; onDelete: (camera: ICamera) => void; }</signature>
      <path>frontend/components/cameras/CameraPreview.tsx:17-26</path>
    </interface>
    <interface>
      <name>ICamera</name>
      <kind>TypeScript interface</kind>
      <signature>interface ICamera { id: string; name: string; type: CameraType; is_enabled: boolean; frame_rate: number; motion_sensitivity: MotionSensitivity; source_type: CameraSourceType; protect_camera_type?: string; is_doorbell?: boolean; updated_at: string; ... }</signature>
      <path>frontend/types/camera.ts:83-109</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend tests use Vitest with React Testing Library. Tests are located in frontend/__tests__/ directory mirroring the source structure. Use mockCamera and mockEvent factories from test-utils.tsx. Wrap components with AllProviders for QueryClient context. Use userEvent for interactions.
    </standards>
    <locations>
      <location>frontend/__tests__/components/cameras/*.test.tsx</location>
      <location>frontend/__tests__/test-utils.tsx</location>
    </locations>
    <ideas>
      <idea ac="1">Test that CameraPreview is properly exported and renders without error</idea>
      <idea ac="2">Test custom comparison function returns true for same camera data</idea>
      <idea ac="2">Test custom comparison function returns false when camera.name changes</idea>
      <idea ac="3">Use React.memo testing pattern: render, update parent state without changing props, verify no re-render</idea>
      <idea ac="3">Verify re-render occurs when camera.is_enabled changes</idea>
      <idea ac="4">Snapshot test to verify no visual regression after memoization</idea>
    </ideas>
  </tests>
</story-context>
