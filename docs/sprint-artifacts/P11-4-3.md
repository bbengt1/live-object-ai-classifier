# Story P11-4.3: Create Smart-Reanalyze Endpoint with Query Matching

Status: done

## Story

As a user,
I want to ask questions about events and get answers,
So that I can find specific details without manually reviewing.

## Acceptance Criteria

1. AC-4.3.1: POST /api/v1/events/{id}/smart-reanalyze?query=... endpoint
2. AC-4.3.2: Query encoded via EmbeddingService.encode_text()
3. AC-4.3.3: Frame embeddings scored against query (cosine similarity)
4. AC-4.3.4: Top-K frames selected for AI analysis
5. AC-4.3.5: AI prompt includes query context

## Tasks / Subtasks

- [x] Task 1: Create SmartReanalyzeRequest schema (AC: 4.3.1)
  - [x] 1.1: Add query field (required)
  - [x] 1.2: Add top_k field (optional, default 5)
  - [x] 1.3: Add min_similarity field (optional, default 0.2)

- [x] Task 2: Create SmartReanalyzeService (AC: 4.3.2, 4.3.3, 4.3.4)
  - [x] 2.1: Create smart_reanalyze_service.py
  - [x] 2.2: Implement query encoding using EmbeddingService.encode_text()
  - [x] 2.3: Implement frame scoring using cosine similarity
  - [x] 2.4: Implement top-K selection with diversity filtering
  - [x] 2.5: Add logging for query matching metrics

- [x] Task 3: Create API endpoint (AC: 4.3.1, 4.3.5)
  - [x] 3.1: Add endpoint to events.py
  - [x] 3.2: Return SmartReanalyzeResponse with updated description
  - [x] 3.3: Pass query context to AI prompt

- [x] Task 4: Write unit tests (AC: all)
  - [x] 4.1: Test query encoding integration
  - [x] 4.2: Test frame scoring logic
  - [x] 4.3: Test top-K selection
  - [x] 4.4: Test diversity filtering
  - [x] 4.5: Test fallback when no frame embeddings exist

## Dev Notes

### Architecture Patterns

This story creates the smart-reanalyze endpoint that ties together text encoding (P11-4.1) and frame embeddings (P11-4.2). The endpoint allows users to ask targeted questions about events.

**Key Design Decisions:**
- Uses batch_cosine_similarity from SimilarityService for efficiency
- Falls back to uniform sampling if no frame embeddings exist
- Query context added to AI prompt for focused analysis

### Implementation Details

**Smart Reanalyze Flow:**
```
User Query → encode_text() → Query Embedding
                                   ↓
          get_frame_embeddings() → Frame Embeddings
                                   ↓
              batch_cosine_similarity() → Scores
                                   ↓
                select_top_k() → Selected Frames
                                   ↓
           AI Analysis (with query context) → New Description
```

### Project Structure Notes

- Add: `backend/app/services/smart_reanalyze_service.py` - Service for query-adaptive reanalysis
- Add: `backend/app/schemas/smart_reanalyze.py` - Request/response schemas
- Modify: `backend/app/api/v1/events.py` - Add smart-reanalyze endpoint
- Add: `backend/tests/test_services/test_smart_reanalyze_service.py` - Tests

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-4.md#SmartReanalyze]
- [Source: docs/research/query-adaptive-frames-research.md#6.1-Integration-Points]
- [Source: backend/app/services/similarity_service.py] - Cosine similarity functions

### Learnings from Previous Stories

**From Story P11-4.1 and P11-4.2:**
- encode_text() returns 512-dim embedding
- get_frame_embeddings() returns list of dicts with frame_index and embedding
- batch_cosine_similarity() is efficient for scoring multiple frames

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-4-1.md (text encoding)
- docs/sprint-artifacts/P11-4-2.md (frame embeddings)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- Created SmartReanalyzeRequest schema with query, top_k, min_similarity, analysis_mode
- Created SmartReanalyzeResponse schema with metrics
- Created SmartReanalyzeService with:
  - select_relevant_frames() - main entry point
  - _select_diverse_frames() - filters near-duplicate frames
  - _cosine_similarity_single() - single pair similarity
- Added POST /api/v1/events/{id}/smart-reanalyze endpoint
- Endpoint passes query context to AI for focused analysis
- Falls back to thumbnail if no frames above similarity threshold
- All 56 tests pass (13 new tests for smart reanalyze)

### File List

**Added:**
- backend/app/services/smart_reanalyze_service.py - SmartReanalyzeService
- backend/tests/test_services/test_smart_reanalyze_service.py - Tests
- docs/sprint-artifacts/P11-4-3.md - Story file

**Modified:**
- backend/app/schemas/event.py - Added SmartReanalyzeRequest/Response
- backend/app/api/v1/events.py - Added smart-reanalyze endpoint

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tests passing |
