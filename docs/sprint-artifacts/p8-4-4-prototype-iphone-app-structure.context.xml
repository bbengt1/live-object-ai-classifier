<story-context id="p8-4-4-prototype-iphone-app-structure" v="1.0">
  <metadata>
    <epicId>P8-4</epicId>
    <storyId>4.4</storyId>
    <title>Prototype iPhone App Structure</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p8-4-4-prototype-iphone-app-structure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a basic iPhone app prototype demonstrating core connectivity</iWant>
    <soThat>we can validate the architecture before full development</soThat>
    <tasks>
      <task id="1">Set up iOS project structure with SwiftUI App lifecycle, iOS 17 target</task>
      <task id="2">Implement Models and Services layer (Event, Camera, AuthToken, APIClient, KeychainService, AuthService)</task>
      <task id="3">Build pairing flow UI with 6-digit code entry and validation</task>
      <task id="4">Build event list view with thumbnails and pull-to-refresh</task>
      <task id="5">Build event detail view with full description</task>
      <task id="6">Implement push notifications with APNS</task>
      <task id="7">Implement local network discovery via Bonjour</task>
      <task id="8">Error handling and retry logic</task>
      <task id="9">Testing and documentation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC4.1">Login/pairing screen with code entry functional</criterion>
    <criterion id="AC4.2">Tokens received and stored in Keychain on valid code</criterion>
    <criterion id="AC4.3">Event list shows recent events with thumbnails</criterion>
    <criterion id="AC4.4">Event detail view shows full description</criterion>
    <criterion id="AC4.5">Pull-to-refresh updates event list</criterion>
    <criterion id="AC4.6">Push notification received when event occurs</criterion>
    <criterion id="AC4.7">Notification tap opens relevant event</criterion>
    <criterion id="AC4.8">Network errors handled gracefully with retry UI</criterion>
    <criterion id="AC4.9">Local ArgusAI discovered via Bonjour</criterion>
    <criterion id="AC4.10">Findings and blockers documented</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/api/mobile-api.yaml" title="ArgusAI Mobile API" section="all">
        OpenAPI 3.1 specification for mobile API endpoints including authentication (pair, verify, refresh),
        events (list, detail, thumbnail, recent), cameras (list, snapshot), and push registration.
      </doc>
      <doc path="docs/architecture/cloud-relay-design.md" title="Cloud Relay Architecture" section="Authentication Flow">
        Device pairing via 6-digit codes (5-minute TTL), JWT tokens (1h access, 30d refresh),
        certificate pinning, Bonjour discovery for local network.
      </doc>
      <doc path="docs/research/apple-apps-technology.md" title="Apple Apps Technology Research" section="Recommendation">
        SwiftUI recommended for iOS 17+, best for APNS, HomeKit, widgets, and Apple platform integration.
        Estimated effort 80-120 hours for iPhone MVP.
      </doc>
      <doc path="docs/sprint-artifacts/tech-spec-epic-P8-4.md" title="Epic Technical Specification" section="P8-4.4">
        iOS project structure template, data models (DevicePairing, PairingCode),
        API contracts, security requirements, and test cases.
      </doc>
      <doc path="docs/epics-phase8.md" title="Phase 8 Epics" section="Story P8-4.4">
        Story definition with core features (pairing, event list, push notifications, local discovery)
        and out-of-scope items (full polish, iPad/Watch/TV/Mac, video playback).
      </doc>
    </docs>
    <code>
      <!-- Note: This story creates a new iOS app - no existing code to reference directly -->
      <!-- However, these backend endpoints must be implemented or mocked for the prototype to work -->
      <file path="backend/app/api/v1/events.py" kind="api" reason="Existing events API patterns to follow for mobile endpoints" />
      <file path="backend/app/api/v1/push.py" kind="api" reason="Existing push notification API for mobile registration" />
      <file path="backend/app/services/push_notification_service.py" kind="service" reason="Backend push service for APNS integration" />
    </code>
    <dependencies>
      <ios>
        <framework>SwiftUI</framework>
        <framework>UIKit (bridging only)</framework>
        <framework>Network (Bonjour)</framework>
        <framework>UserNotifications (push)</framework>
        <framework>Security (Keychain)</framework>
        <framework>AVFoundation (potential video)</framework>
        <package>KeychainAccess (optional, for simplified Keychain)</package>
      </ios>
      <backend>
        <!-- Existing backend dependencies that mobile app will interact with -->
        <package>python-jose[cryptography]>=3.5.0</package>
        <package>pywebpush>=2.0.0</package>
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>iOS 17+ minimum deployment target (required for latest SwiftUI features)</constraint>
    <constraint>SwiftUI for all UI components (no UIKit except bridging)</constraint>
    <constraint>@Observable macro for view models (iOS 17+)</constraint>
    <constraint>Keychain for all credential storage (never UserDefaults)</constraint>
    <constraint>6-digit numeric pairing codes with 5-minute TTL</constraint>
    <constraint>JWT access tokens expire in 1 hour, refresh tokens in 30 days</constraint>
    <constraint>Refresh tokens rotated on each use</constraint>
    <constraint>Bearer token authentication on all API requests</constraint>
    <constraint>TLS 1.3 required for all connections</constraint>
    <constraint>Certificate pinning recommended for production</constraint>
    <constraint>Bonjour service type: _argusai._tcp.local</constraint>
    <constraint>Prefer local network connection over cloud relay</constraint>
    <constraint>Prototype scope: iPhone only (no iPad/Watch/TV/Mac)</constraint>
    <constraint>Requires Apple Developer account for push testing on device</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /auth/pair" kind="REST">
      <signature>POST /api/v1/mobile/auth/pair { device_id, device_name, device_model? } -> { pairing_code, expires_at }</signature>
      <path>docs/api/mobile-api.yaml#/auth/pair</path>
    </interface>
    <interface name="POST /auth/verify" kind="REST">
      <signature>POST /api/v1/mobile/auth/verify { pairing_code, device_id } -> { access_token, refresh_token, token_type, expires_in }</signature>
      <path>docs/api/mobile-api.yaml#/auth/verify</path>
    </interface>
    <interface name="POST /auth/refresh" kind="REST">
      <signature>POST /api/v1/mobile/auth/refresh { refresh_token } -> { access_token, refresh_token, token_type, expires_in }</signature>
      <path>docs/api/mobile-api.yaml#/auth/refresh</path>
    </interface>
    <interface name="GET /events" kind="REST">
      <signature>GET /api/v1/mobile/events?camera_id&amp;start_time&amp;end_time&amp;limit&amp;offset -> { events[], total_count, has_more }</signature>
      <path>docs/api/mobile-api.yaml#/events</path>
    </interface>
    <interface name="GET /events/recent" kind="REST">
      <signature>GET /api/v1/mobile/events/recent?limit=5 -> { events[] }</signature>
      <path>docs/api/mobile-api.yaml#/events/recent</path>
    </interface>
    <interface name="GET /events/{id}" kind="REST">
      <signature>GET /api/v1/mobile/events/{event_id} -> EventResponse</signature>
      <path>docs/api/mobile-api.yaml#/events/{event_id}</path>
    </interface>
    <interface name="GET /events/{id}/thumbnail" kind="REST">
      <signature>GET /api/v1/mobile/events/{event_id}/thumbnail -> image/jpeg (30-50KB)</signature>
      <path>docs/api/mobile-api.yaml#/events/{event_id}/thumbnail</path>
    </interface>
    <interface name="GET /cameras" kind="REST">
      <signature>GET /api/v1/mobile/cameras -> { cameras[] }</signature>
      <path>docs/api/mobile-api.yaml#/cameras</path>
    </interface>
    <interface name="POST /push/register" kind="REST">
      <signature>POST /api/v1/mobile/push/register { device_token, device_id } -> { id, registered_at }</signature>
      <path>docs/api/mobile-api.yaml#/push/register</path>
    </interface>
    <interface name="Bonjour Service" kind="mDNS">
      <signature>_argusai._tcp.local -> { host, port, TXT record with version }</signature>
      <path>docs/architecture/cloud-relay-design.md#local-network-fallback</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      XCTest framework for unit and integration tests. Use XCTestCase for test classes.
      Follow AAA pattern (Arrange, Act, Assert). Mock network calls with URLProtocol.
      Test ViewModels independently from Views. Use dependency injection for services.
      Physical device required for push notification testing (simulator has limitations).
    </standards>
    <locations>
      <location>ios-app/ArgusAITests/ViewModels/</location>
      <location>ios-app/ArgusAITests/Services/</location>
    </locations>
    <ideas>
      <idea ac="AC4.1">Test PairingViewModel validates 6-digit codes, handles empty/invalid input</idea>
      <idea ac="AC4.2">Test AuthService stores tokens in Keychain on successful verification</idea>
      <idea ac="AC4.2">Test AuthService handles expired codes, invalid codes, network errors</idea>
      <idea ac="AC4.3">Test EventListViewModel fetches and parses events correctly</idea>
      <idea ac="AC4.3">Test EventListViewModel handles empty response, pagination</idea>
      <idea ac="AC4.5">Test pull-to-refresh triggers reload and updates list</idea>
      <idea ac="AC4.8">Test APIClient handles network timeouts, 401 refresh, 500 errors</idea>
      <idea ac="AC4.8">Test retry logic with exponential backoff</idea>
      <idea ac="AC4.9">Test DiscoveryService finds local ArgusAI service</idea>
    </ideas>
  </tests>
</story-context>
